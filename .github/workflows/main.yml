name: Build docker images & run tests

on:
  push:
    branches:
      # run for all pushes to master
      - master
    tags:
      # run for all pushes to any tags
      - "*"
  pull_request:
    # run for all opens/pushes/merges of PRs
    # to run on merge, we use `closed` in conjunction with
    # `if: github.event.pull_request.merged` in job
    types: [opened, reopened, synchronize, closed ]

jobs:
  #checkout:
  #  runs-on: ubuntu-latest
  #  steps:
  #    - name: Checkout code
  #      uses: actions/checkout@v3

  wasm-linux-clang:
    runs-on: ubuntu-latest
    #needs: checkout
    #container: aztecprotocol/alpine-build-image
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      #- name: Setup environment
      #  run: cd .circleci && source ./setup_env && cd ../
      - name: Build
        #run: cd .circleci && source ./setup_env && cd ../ && pwd && bash .circleci/cond_spot_run_build barretenberg-wasm-linux-clang 64
        run: set -x && source ./.circleci/setup_env && bash .circleci/build barretenberg-wasm-linux-clang ignore_cache

  x86_64-linux-clang:
    runs-on: ubuntu-latest
    #needs: checkout
    #container: aztecprotocol/alpine-build-image
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      #- name: Setup environment
      #  run: cd .circleci && source ./setup_env && cd ../
      - name: Build
        #run: cd .circleci && source ./setup_env && cd ../ && pwd && bash .circleci/cond_spot_run_build barretenberg-wasm-linux-clang 64
        run: set -x && source ./.circleci/setup_env && bash .circleci/build barretenberg-x86_64-linux-clang ignore_cache


# When setting up builds, using `container: aztecprotocol/alpine-build-image` results in:
# ```
# fatal: detected dubious ownership in repository at '/__w/barretenberg/barretenberg'
# To add an exception for this directory, call:
#
#	  git config --global --add safe.directory /__w/barretenberg/barretenberg
# ```
#
# To work around this for now I had to remove `container: aztecprotocl/alpine-build-image`
#
# Things I tried that did not work:
# * revert to `actions/checkout@v2`
# * add the following to `uses: actions/checkout@v3` (or v2), but I don't totally follow what this does:
#   ```
#      with:
#        set-safe-directory: true
#        token: ${{ secrets.GITHUB_TOKEN }}
#   ```
# * manually run the following before the checkout step:
#   ```
#     run: |
#       apk update && apk add git
#       /usr/bin/git config --global --add safe.directory /__w/barretenberg/barretenberg
#   ```
